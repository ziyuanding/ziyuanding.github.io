<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>在Typst里渲染R代码块运行结果 |</title><link rel=stylesheet href=https://ziyuanding.github.io/css/main.min.ae047bae72f7cfdc69dab3d0757b51bb79c4c867ba9a336983ec0c2a20c576eb.css integrity="sha256-rgR7rnL3z9xp2rPQdXtRu3nEyGe6mjNpg+wMKiDFdus="><link rel=stylesheet href=https://ziyuanding.github.io/semantic/dist/semantic.min.css><link rel=stylesheet href=https://ziyuanding.github.io/css/vendor/syntax.css><script src=https://code.jquery.com/jquery-2.2.2.min.js integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=" crossorigin=anonymous></script><script src=/semantic/dist/semantic.min.js></script><script src=/js/vendor/fontawesome-all.js></script></head><body><header><nav><div class="ui grid container"><div class="computer only row"><div class="ui fluid large borderless blue menu"><div class="fitted item"><a href=/ style=text-decoration:none;color:#000><b>DING</b></a></div><div class="ui dropdown item"><b>BROWSE</b>
<i class="angle down icon"></i><div class=menu><a class=item href=/browse><i class="far fa-globe icon"></i>Everything</a><div class=divider></div><a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=projects"><i class="far fa-briefcase icon"></i>Projects</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=startups"><i class="far fa-rocket icon"></i>Startups</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=labs"><i class="far fa-flask icon"></i>Labs</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=incubators"><i class="far fa-leaf icon"></i>Incubators</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=groups"><i class="far fa-users icon"></i>Groups</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=networks"><i class="far fa-share-alt icon"></i>Networks</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=events"><i class="far fa-calendar-alt icon"></i>Events</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=others"><i class="far fa-umbrella icon"></i>Others</a></div></div><div class=item><div class="ui fluid transparent icon input"><input type=text id=aa-search-input class=aa-input-search placeholder="Search Ding's blog posts" autocomplete=on>
<i class="search icon"></i></div></div><div class="right menu"><div class="ui item"><a href=/about style=text-decoration:none;color:#000><b>ABOUT</b></a></div><div class="ui item" style=padding-left:5px!important;padding-right:5px!important><a href=https://www.linkedin.com/in/ziyuan-ding-467314249/ target=_blank style=text-decoration:none;color:#000><i class="linkedin icon"></i></a></div><div class="ui item" style=padding-left:5px!important;padding-right:5px!important><a href=https://github.com/ziyuanding target=_blank style=text-decoration:none;color:#000><i class="github icon"></i></a></div></div></div></div><div class="tablet only row"><div class="ui fluid large borderless blue menu"><div class="fitted item"><a href=/ style=text-decoration:none;color:#000><b>DING</b></a></div><div class="ui dropdown item"><b>BROWSE</b>
<i class="angle down icon"></i><div class=menu><a class=item href=/browse><i class="far fa-globe icon"></i>Everything</a><div class=divider></div><a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=projects"><i class="far fa-briefcase icon"></i>Projects</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=startups"><i class="far fa-rocket icon"></i>Startups</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=labs"><i class="far fa-flask icon"></i>Labs</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=incubators"><i class="far fa-leaf icon"></i>Incubators</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=groups"><i class="far fa-users icon"></i>Groups</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=networks"><i class="far fa-share-alt icon"></i>Networks</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=events"><i class="far fa-calendar-alt icon"></i>Events</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=others"><i class="far fa-umbrella icon"></i>Others</a></div></div><div class=item><div class="ui fluid transparent icon input"><input type=search id=aa-search-input-tablet class=aa-input-search placeholder="Search Ding's blog posts" name=search autocomplete=on>
<i class="search icon"></i></div></div><div class="right menu"><div class="ui right dropdown icon item"><i class="sidebar icon"></i><div class=menu><div class=header>About</div><a class=item href=/about/diybiosphere-project><i class="far fa-info fa-fw icon"></i>DIYbiosphere</a>
<a class=item href=/about/philosophy><i class="far fa-compass fa-fw icon"></i>Philosophy</a>
<a class=item href=/about/community><i class="far fa-heart fa-fw icon"></i>Our Community</a>
<a class=item href=/about/contact><i class="far fa-paper-plane fa-fw icon"></i>Contact</a><div class=divider></div><div class=header>Contribute</div><a class=item href=/docs/tutorials/add-entry><i class="far fa-plus-square fa-fw icon"></i>Add Entry via Github (markdown)</a>
<a class=item href=/docs/tutorials/edit-entry><i class="far fa-pen-square fa-fw icon"></i>Edit Content</a>
<a class=item target=_blank href=https://github.com/DIYbiosphere/sphere><i class="fab fa-github fa-fw icon"></i>Github (repo)</a>
<a class=item href=/docs/><i class="far fa-book fa-fw icon"></i>Learn More (docs)</a>
<a class=item href=/about/support-us><i class="far fa-thumbs-up fa-fw icon"></i>Support Us</a></div></div></div></div></div><div class="mobile only row"><div class="ui fluid borderless blue menu xo marginless"><div class="fitted item"><a href=/ style=text-decoration:none;color:#000><b>DING</b></a></div><div class="ui dropdown item"><b>BROWSE</b>
<i class="angle down icon"></i><div class=menu><a class=item href=/browse><i class="far fa-globe icon"></i>Everything</a><div class=divider></div><a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=projects"><i class="far fa-briefcase icon"></i>Projects</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=startups"><i class="far fa-rocket icon"></i>Startups</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=labs"><i class="far fa-flask icon"></i>Labs</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=incubators"><i class="far fa-leaf icon"></i>Incubators</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=groups"><i class="far fa-users icon"></i>Groups</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=networks"><i class="far fa-share-alt icon"></i>Networks</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=events"><i class="far fa-calendar-alt icon"></i>Events</a>
<a class=item href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=others"><i class="far fa-umbrella icon"></i>Others</a></div></div><div class="right menu"><div class="ui right dropdown icon item"><i class="sidebar icon"></i><div class=menu><div class=header>About</div><a class=item href=/about/diybiosphere-project><i class="far fa-info fa-fw icon"></i>DIYbiosphere</a>
<a class=item href=/about/philosophy><i class="far fa-compass fa-fw icon"></i>Philosophy</a>
<a class=item href=/about/community><i class="far fa-heart fa-fw icon"></i>Our Community</a>
<a class=item href=/about/contact><i class="far fa-paper-plane fa-fw icon"></i>Contact</a><div class=divider></div><div class=header>Contribute</div><a class=item href=/docs/tutorials/add-entry><i class="far fa-plus-square fa-fw icon"></i>Add Entry via Github (markdown)</a>
<a class=item href=/docs/tutorials/edit-entry><i class="far fa-pen-square fa-fw icon"></i>Edit Content</a>
<a class=item target=_blank href=https://github.com/DIYbiosphere/sphere><i class="fab fa-github fa-fw icon"></i>Github (repo)</a>
<a class=item href=/docs/><i class="far fa-book fa-fw icon"></i>Learn More (docs)</a>
<a class=item href=/about/support-us><i class="far fa-thumbs-up fa-fw icon"></i>Support Us</a></div></div></div></div><div class="ui fluid borderless menu xo marginless center aligned"><div class=item><div class="ui fluid transparent icon input"><input type=search id=aa-search-input-mobile class=aa-input-search placeholder="Search Ding's blog posts" name=search autocomplete=on>
<i class="search icon"></i></div></div></div></div></div></nav></header><main><div class="ui grid container xo top padding"><div class="computer only row"><div class="eleven wide column"><div class="xo padding top bottom"><div class="ui mini horizontal divided link list"><div class="disabled item">Last edit: 2023-11-29</div><a class="item noelink noul" href=https://github.com//blob/master/posts/%e5%9c%a8Typst%e9%87%8c%e6%b8%b2%e6%9f%93R%e4%bb%a3%e7%a0%81%e5%9d%97%e8%bf%90%e8%a1%8c%e7%bb%93%e6%9e%9c.md target=_blank><span data-tooltip="Edit page in GitHub" data-variation=mini data-inverted><i class="fal fa-edit" data-fa-transform="grow-6 right-6"></i>
</span></a><a class="item noelink noul" href=https://github.com//issues/new target=_blank><span data-tooltip="Open GitHub Issue" data-variation=mini data-inverted><i class="fal fa-bug" data-fa-transform="grow-6 right-6"></i>
</span></a><a class="item noelink noul" href=https://github.com//issues/new target=_blank><span data-tooltip="Open Comments Issue in GitHub" data-variation=mini data-inverted><i class="fal fa-comments" data-fa-transform="grow-6 right-6"></i></span></a></div></div><article><h1 class="ui xo margin top without"><div class="ui medium">在Typst里渲染R代码块运行结果</div></h1><h2 id=typst是什么>Typst是什么</h2><p>Typst是一个文档排版工具，包含一种标记语言，一个编译工具，还有正在快速发展的生态。Typst语言有一套有趣的语法，相对Tex语言来说可以更加简洁明了地表达大部分文档排版的需求。</p><h2 id=为什么要在typst里渲染r代码块的运行结果>为什么要在Typst里渲染R代码块的运行结果？</h2><p>主要是期望在Typst中也能做到文学编程。而R语言又常常是文学编程中“编程"的那一部分。</p><h2 id=现阶段的问题>现阶段的问题</h2><p>通过使用knitr, 现在其实已经可以比较好地渲染文本类输出了。主要是图片信息显示格式错误。而这个错误又是因为knitr官方在当前时间点（2023年11月）并不支持typ文件的织入，只不过typ文件的代码块语法和md文件类似，而knitr在fallback情况下又是使用md语法去抓取代码块和织入结果，所以造成了”只有文本输出正常，图片输出有bug“的错觉——人家本就完全不支持。<br>相关issue:<br><a href=https://github.com/typst/typst/issues/1978>https://github.com/typst/typst/issues/1978</a><br><a href=https://github.com/yihui/knitr/issues/2283>https://github.com/yihui/knitr/issues/2283</a></p><h2 id=如何做>如何做？</h2><p>然而，knitr是一个相当自由的工具，在其工作流的前前后后，都有丰富的hook可供使用。对于我们的问题来说，我们只需要把图片输出修好，就可以完成临门一脚，使其凑凑活活达成我们的目标。
这里，我编写了一个plot函数的hook，只要把这段代码放在typ文档的最前面（当然，这段代码本身只需要被执行而不需要被渲染），就可以使后续文章中所有R代码输出的图片都会被knitr正确地以typst的格式织入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=c1># this chunk should be at the beginning of your paper. chunk option should be {r, echo=FALSE}</span>
</span></span><span class=line><span class=cl><span class=nf>local</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=n>hook_old</span> <span class=o>&lt;-</span> <span class=n>knitr</span><span class=o>::</span><span class=n>knit_hooks</span><span class=o>$</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;plot&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>knitr</span><span class=o>::</span><span class=n>knit_hooks</span><span class=o>$</span><span class=nf>set</span><span class=p>(</span><span class=n>plot</span> <span class=c1>## function(x, options) {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#print(options)</span>
</span></span><span class=line><span class=cl>  <span class=n>image_path</span> <span class=o>&lt;-</span> <span class=nf>paste</span><span class=p>(</span><span class=n>options</span><span class=o>$</span><span class=n>fig.path</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>label</span><span class=p>,</span> <span class=s>&#39;-&#39;</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.cur</span><span class=p>,</span> <span class=s>&#39;.&#39;</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.ext</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>image_caption</span> <span class=o>&lt;-</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.cap</span>
</span></span><span class=line><span class=cl>  <span class=n>result_string</span> <span class=o>&lt;-</span> <span class=nf>sprintf</span><span class=p>(</span><span class=s>&#34;#figure(\n  image(\&#34;%s\&#34;, width:%s),\n  caption: [%s],\n)&#34;</span><span class=p>,</span><span class=n>image_path</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>out.width</span><span class=p>,</span> <span class=n>image_caption</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>我这里只是用来验证想法，写的很简陋，图像控制的参数我只传了caption 和 width。但是可能性是无限大的，你想要什么自己手动添加参数就好了。</p><p>实际的工作流稍显麻烦，但至少能用了：</p><ol><li>写typ文件（我们就叫这个文件feed-me-to-knitr.typ吧），记得把上述代码加到开头</li><li>R会话里运行命令 <code>knit("feed-me-to-knitr.typ", "feed-me-to-typst.typ")</code></li><li>命令行运行<code>typst compile "feed-me-to-typst.typ" final.pdf</code>，得到最终的pdf文件
上述提到的这些示例文件可以在这里下载到：
#link(&ldquo;<a href=https://github.com/yihui/knitr/files/13463399/typst-r.zip%22>https://github.com/yihui/knitr/files/13463399/typst-r.zip"</a>)</li></ol></article></div><div class="five wide column"><div class="ui attached segment"><table class="ui very basic small compact table"><tbody><tr><td><b>Collection:</b></td><td><a class=noelink href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=" target=_blank></a></td></tr><tr class="top aligned"><td><b>Location:</b></td><td><span><a href="http://maps.google.com/?q=" target=_blank></a></span></td></tr></tbody></table></div><div class="ui bottom attached segment"></div></div></div><div class="tablet only row"><div class="nine wide column"><div class="xo padding top bottom"><div class="ui mini horizontal divided link list"><div class="disabled item">Last edit: 2023-11-29</div><a class="item noelink noul" href=https://github.com//blob/master/posts/%e5%9c%a8Typst%e9%87%8c%e6%b8%b2%e6%9f%93R%e4%bb%a3%e7%a0%81%e5%9d%97%e8%bf%90%e8%a1%8c%e7%bb%93%e6%9e%9c.md target=_blank><span data-tooltip="Edit page in GitHub" data-variation=mini data-inverted><i class="fal fa-edit" data-fa-transform="grow-6 right-6"></i>
</span></a><a class="item noelink noul" href=https://github.com//issues/new target=_blank><span data-tooltip="Open GitHub Issue" data-variation=mini data-inverted><i class="fal fa-bug" data-fa-transform="grow-6 right-6"></i>
</span></a><a class="item noelink noul" href=https://github.com//issues/new target=_blank><span data-tooltip="Open Comments Issue in GitHub" data-variation=mini data-inverted><i class="fal fa-comments" data-fa-transform="grow-6 right-6"></i></span></a></div></div><article><h1 class="ui xo margin top without"><div class="ui medium">在Typst里渲染R代码块运行结果</div></h1><h2 id=typst是什么>Typst是什么</h2><p>Typst是一个文档排版工具，包含一种标记语言，一个编译工具，还有正在快速发展的生态。Typst语言有一套有趣的语法，相对Tex语言来说可以更加简洁明了地表达大部分文档排版的需求。</p><h2 id=为什么要在typst里渲染r代码块的运行结果>为什么要在Typst里渲染R代码块的运行结果？</h2><p>主要是期望在Typst中也能做到文学编程。而R语言又常常是文学编程中“编程"的那一部分。</p><h2 id=现阶段的问题>现阶段的问题</h2><p>通过使用knitr, 现在其实已经可以比较好地渲染文本类输出了。主要是图片信息显示格式错误。而这个错误又是因为knitr官方在当前时间点（2023年11月）并不支持typ文件的织入，只不过typ文件的代码块语法和md文件类似，而knitr在fallback情况下又是使用md语法去抓取代码块和织入结果，所以造成了”只有文本输出正常，图片输出有bug“的错觉——人家本就完全不支持。<br>相关issue:<br><a href=https://github.com/typst/typst/issues/1978>https://github.com/typst/typst/issues/1978</a><br><a href=https://github.com/yihui/knitr/issues/2283>https://github.com/yihui/knitr/issues/2283</a></p><h2 id=如何做>如何做？</h2><p>然而，knitr是一个相当自由的工具，在其工作流的前前后后，都有丰富的hook可供使用。对于我们的问题来说，我们只需要把图片输出修好，就可以完成临门一脚，使其凑凑活活达成我们的目标。
这里，我编写了一个plot函数的hook，只要把这段代码放在typ文档的最前面（当然，这段代码本身只需要被执行而不需要被渲染），就可以使后续文章中所有R代码输出的图片都会被knitr正确地以typst的格式织入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=c1># this chunk should be at the beginning of your paper. chunk option should be {r, echo=FALSE}</span>
</span></span><span class=line><span class=cl><span class=nf>local</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=n>hook_old</span> <span class=o>&lt;-</span> <span class=n>knitr</span><span class=o>::</span><span class=n>knit_hooks</span><span class=o>$</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;plot&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>knitr</span><span class=o>::</span><span class=n>knit_hooks</span><span class=o>$</span><span class=nf>set</span><span class=p>(</span><span class=n>plot</span> <span class=c1>## function(x, options) {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#print(options)</span>
</span></span><span class=line><span class=cl>  <span class=n>image_path</span> <span class=o>&lt;-</span> <span class=nf>paste</span><span class=p>(</span><span class=n>options</span><span class=o>$</span><span class=n>fig.path</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>label</span><span class=p>,</span> <span class=s>&#39;-&#39;</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.cur</span><span class=p>,</span> <span class=s>&#39;.&#39;</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.ext</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>image_caption</span> <span class=o>&lt;-</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.cap</span>
</span></span><span class=line><span class=cl>  <span class=n>result_string</span> <span class=o>&lt;-</span> <span class=nf>sprintf</span><span class=p>(</span><span class=s>&#34;#figure(\n  image(\&#34;%s\&#34;, width:%s),\n  caption: [%s],\n)&#34;</span><span class=p>,</span><span class=n>image_path</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>out.width</span><span class=p>,</span> <span class=n>image_caption</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>我这里只是用来验证想法，写的很简陋，图像控制的参数我只传了caption 和 width。但是可能性是无限大的，你想要什么自己手动添加参数就好了。</p><p>实际的工作流稍显麻烦，但至少能用了：</p><ol><li>写typ文件（我们就叫这个文件feed-me-to-knitr.typ吧），记得把上述代码加到开头</li><li>R会话里运行命令 <code>knit("feed-me-to-knitr.typ", "feed-me-to-typst.typ")</code></li><li>命令行运行<code>typst compile "feed-me-to-typst.typ" final.pdf</code>，得到最终的pdf文件
上述提到的这些示例文件可以在这里下载到：
#link(&ldquo;<a href=https://github.com/yihui/knitr/files/13463399/typst-r.zip%22>https://github.com/yihui/knitr/files/13463399/typst-r.zip"</a>)</li></ol></article></div><div class="seven wide column"><div class="ui attached segment"><table class="ui very basic small compact table"><tbody><tr><td><b>Collection:</b></td><td><a class=noelink href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=" target=_blank></a></td></tr><tr class="top aligned"><td><b>Location:</b></td><td><span><a href="http://maps.google.com/?q=" target=_blank></a></span></td></tr></tbody></table></div><div class="ui bottom attached segment"></div></div></div><div class="mobile only row"><div class="sixteen wide column"><div class="ui attached segment"><table class="ui very basic small compact table"><tbody><tr><td><b>Collection:</b></td><td><a class=noelink href="/browse?q=&idx=diybiosphere&p=0&dFR%5Bcollection%5D%5B0%5D=" target=_blank></a></td></tr><tr class="top aligned"><td><b>Location:</b></td><td><span><a href="http://maps.google.com/?q=" target=_blank></a></span></td></tr></tbody></table></div><div class="ui bottom attached segment"></div></div><div class="sixteen wide column xo top padding fourfold"><div class="xo padding top bottom"><div class="ui mini horizontal divided link list"><div class="disabled item">Last edit: 2023-11-29</div><a class="item noelink noul" href=https://github.com//blob/master/posts/%e5%9c%a8Typst%e9%87%8c%e6%b8%b2%e6%9f%93R%e4%bb%a3%e7%a0%81%e5%9d%97%e8%bf%90%e8%a1%8c%e7%bb%93%e6%9e%9c.md target=_blank><span data-tooltip="Edit page in GitHub" data-variation=mini data-inverted><i class="fal fa-edit" data-fa-transform="grow-6 right-6"></i>
</span></a><a class="item noelink noul" href=https://github.com//issues/new target=_blank><span data-tooltip="Open GitHub Issue" data-variation=mini data-inverted><i class="fal fa-bug" data-fa-transform="grow-6 right-6"></i>
</span></a><a class="item noelink noul" href=https://github.com//issues/new target=_blank><span data-tooltip="Open Comments Issue in GitHub" data-variation=mini data-inverted><i class="fal fa-comments" data-fa-transform="grow-6 right-6"></i></span></a></div></div><article><h1 class="ui xo margin top without"><div class="ui medium">在Typst里渲染R代码块运行结果</div></h1><h2 id=typst是什么>Typst是什么</h2><p>Typst是一个文档排版工具，包含一种标记语言，一个编译工具，还有正在快速发展的生态。Typst语言有一套有趣的语法，相对Tex语言来说可以更加简洁明了地表达大部分文档排版的需求。</p><h2 id=为什么要在typst里渲染r代码块的运行结果>为什么要在Typst里渲染R代码块的运行结果？</h2><p>主要是期望在Typst中也能做到文学编程。而R语言又常常是文学编程中“编程"的那一部分。</p><h2 id=现阶段的问题>现阶段的问题</h2><p>通过使用knitr, 现在其实已经可以比较好地渲染文本类输出了。主要是图片信息显示格式错误。而这个错误又是因为knitr官方在当前时间点（2023年11月）并不支持typ文件的织入，只不过typ文件的代码块语法和md文件类似，而knitr在fallback情况下又是使用md语法去抓取代码块和织入结果，所以造成了”只有文本输出正常，图片输出有bug“的错觉——人家本就完全不支持。<br>相关issue:<br><a href=https://github.com/typst/typst/issues/1978>https://github.com/typst/typst/issues/1978</a><br><a href=https://github.com/yihui/knitr/issues/2283>https://github.com/yihui/knitr/issues/2283</a></p><h2 id=如何做>如何做？</h2><p>然而，knitr是一个相当自由的工具，在其工作流的前前后后，都有丰富的hook可供使用。对于我们的问题来说，我们只需要把图片输出修好，就可以完成临门一脚，使其凑凑活活达成我们的目标。
这里，我编写了一个plot函数的hook，只要把这段代码放在typ文档的最前面（当然，这段代码本身只需要被执行而不需要被渲染），就可以使后续文章中所有R代码输出的图片都会被knitr正确地以typst的格式织入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=c1># this chunk should be at the beginning of your paper. chunk option should be {r, echo=FALSE}</span>
</span></span><span class=line><span class=cl><span class=nf>local</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=n>hook_old</span> <span class=o>&lt;-</span> <span class=n>knitr</span><span class=o>::</span><span class=n>knit_hooks</span><span class=o>$</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;plot&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>knitr</span><span class=o>::</span><span class=n>knit_hooks</span><span class=o>$</span><span class=nf>set</span><span class=p>(</span><span class=n>plot</span> <span class=c1>## function(x, options) {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#print(options)</span>
</span></span><span class=line><span class=cl>  <span class=n>image_path</span> <span class=o>&lt;-</span> <span class=nf>paste</span><span class=p>(</span><span class=n>options</span><span class=o>$</span><span class=n>fig.path</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>label</span><span class=p>,</span> <span class=s>&#39;-&#39;</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.cur</span><span class=p>,</span> <span class=s>&#39;.&#39;</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.ext</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>image_caption</span> <span class=o>&lt;-</span> <span class=n>options</span><span class=o>$</span><span class=n>fig.cap</span>
</span></span><span class=line><span class=cl>  <span class=n>result_string</span> <span class=o>&lt;-</span> <span class=nf>sprintf</span><span class=p>(</span><span class=s>&#34;#figure(\n  image(\&#34;%s\&#34;, width:%s),\n  caption: [%s],\n)&#34;</span><span class=p>,</span><span class=n>image_path</span><span class=p>,</span> <span class=n>options</span><span class=o>$</span><span class=n>out.width</span><span class=p>,</span> <span class=n>image_caption</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>我这里只是用来验证想法，写的很简陋，图像控制的参数我只传了caption 和 width。但是可能性是无限大的，你想要什么自己手动添加参数就好了。</p><p>实际的工作流稍显麻烦，但至少能用了：</p><ol><li>写typ文件（我们就叫这个文件feed-me-to-knitr.typ吧），记得把上述代码加到开头</li><li>R会话里运行命令 <code>knit("feed-me-to-knitr.typ", "feed-me-to-typst.typ")</code></li><li>命令行运行<code>typst compile "feed-me-to-typst.typ" final.pdf</code>，得到最终的pdf文件
上述提到的这些示例文件可以在这里下载到：
#link(&ldquo;<a href=https://github.com/yihui/knitr/files/13463399/typst-r.zip%22>https://github.com/yihui/knitr/files/13463399/typst-r.zip"</a>)</li></ol></article></div></div></div><div class="ui grid container xo top padding"><section class="xo margin top fourfold"><h3 class="ui horizontal divider header"><i class="far fa-comments"></i> Comments</h3><a target=_blank href=https://github.com//issues/new><div class="ui basic submit mini button"><i class="fal fa-comment"></i> Open Comments Issue in GitHub</div></a></section></div><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js></script><script type=text/javascript>function loadComments(e){for(var n,s,o,i,a,r,c,t=0;t<e.length;t++)s=e[t].user.login,o="https://www.github.com/"+e[t].user.login,c=e[t].user.type,n="https://github.com//issues/#issuecomment-"+e[t].url.substring(e[t].url.lastIndexOf("/")+1),i=e[t].body_html,a=e[t].user.avatar_url,r=Date.parse(e[t].created_at).toString("yyyy-MM-dd HH:mm"),$("#comments").append(`<div class='comment'><a class='avatar'><img src="`+a+`"></a><div class='content'><a class='author' target='_blank' href="`+o+'">'+s+"</a><div class='metadata'><div class='date'>"+r+"</div></div><div class='text'>"+i+`</div></div><div class='actions'><a target='_blank' href="`+n+`" class='reply'><i class='far fa-reply'></i> Reply</a><a target='_blank' href="`+n+`" class='reply'><i class='far fa-smile'></i> React</a></div></div></div>`)}</script></main><footer><footer class="xo top margin sixfold"><div class="ui container center aligned grid xo top bottom padding"><div class=row><div class="sixteen wide column"><div class="ui small horizontal divided link list"><a class=item href=https://github.com/DIYbiosphere/sphere>This site's theme is powered by DIYbiosphere under CC0.</a></div></div></div></div></footer></footer></body></html>